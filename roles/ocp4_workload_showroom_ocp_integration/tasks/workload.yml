---
- name: Resolve OpenShift API URL for ocp4_workload_showroom_ocp_integration
  set_fact:
    openshift_api_url: >-
      {{
        ocp4_workload_showroom_ocp_integration_openshift_api_url
        | default(openshift_api_url, true)
      }}

- name: Resolve OpenShift API token for ocp4_workload_showroom_ocp_integration
  set_fact:
    openshift_api_key: >-
      {{
        ocp4_workload_showroom_ocp_integration_openshift_api_token
        | default(openshift_cluster_admin_token, true)
        | default(openshift_api_token, true)
        | default(openshift_api_key, true)
      }}

- name: Login to OpenShift with token
  command: >
    oc login {{ openshift_api_url if 'https' in openshift_api_url else 'https://' + openshift_api_url + ':6443' }}
    --token={{ openshift_api_key }}
    --insecure-skip-tls-verify
    --kubeconfig=/tmp/kubeconfig-demo
  register: oc_login
  retries: 10
  delay: 30
  until: oc_login.rc == 0

- name: Remove X-Frame-Options header from default ingresscontroller
  kubernetes.core.k8s:
    api_version: operator.openshift.io/v1
    kind: IngressController
    name: default
    namespace: openshift-ingress-operator
    merge_type: merge
    definition:
      spec:
        httpHeaders:
          actions:
            response:
            - action:
                type: Delete
              name: X-Frame-Options
            - action:
                type: Delete
              name: Content-Security-Policy
            - action:
                type: Delete
              name: referrer-policy
  register: remove_header
  retries: 20
  delay: 3
  until: remove_header is not failed

- name: Get service-ca.crt from v4-0-config-system-service-ca ConfigMap
  kubernetes.core.k8s_info:
    api_version: v1
    kind: ConfigMap
    name: v4-0-config-system-service-ca
    namespace: openshift-authentication
  register: service_ca_cm
  retries: 20
  delay: 3
  until: service_ca_cm is not failed

- name: Extract service-ca.crt content
  set_fact:
    service_ca_crt: "{{ service_ca_cm.resources[0].data['service-ca.crt'] }}"


- name: Patch oauth-openshift route to use reencrypt and service-ca.crt
  kubernetes.core.k8s:
    api_version: route.openshift.io/v1
    kind: Route
    name: oauth-openshift
    namespace: openshift-authentication
    definition:
      spec:
        tls:
          termination: reencrypt
          destinationCACertificate: "{{ service_ca_crt }}"
    merge_type: merge
  register: patch_oauth_route
  retries: 20
  delay: 3
  until: patch_oauth_route is not failed

- name: Wait for router deployment to be ready after IngressController change
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: router-default
    namespace: openshift-ingress
  register: router_deployment
  retries: 40
  delay: 15
  until:
    - router_deployment.resources | length > 0
    - router_deployment.resources[0].status.observedGeneration is defined
    - router_deployment.resources[0].status.observedGeneration == router_deployment.resources[0].metadata.generation
    - router_deployment.resources[0].status.updatedReplicas is defined
    - router_deployment.resources[0].status.updatedReplicas == router_deployment.resources[0].spec.replicas
    - router_deployment.resources[0].status.readyReplicas is defined
    - router_deployment.resources[0].status.readyReplicas == router_deployment.resources[0].spec.replicas


- name: Get oauth URL
  kubernetes.core.k8s_info:
    api_version: route.openshift.io/v1
    kind: Route
    name: oauth-openshift
    namespace: openshift-authentication
  register: oauth_route

- name: Add oauth-openshift route to use reencrypt and service-ca.crt
  kubernetes.core.k8s:
    api_version: route.openshift.io/v1
    kind: Route
    name: oauth-openshift-new
    namespace: openshift-authentication
    definition:
      spec:
        host: "{{ oauth_route.resources[0].spec.host }}"
        tls:
          termination: reencrypt
          destinationCACertificate: "{{ service_ca_crt }}"
        to:
          kind: Service
          name: oauth-openshift
          weight: 100
        port:
          targetPort: 6443
        wildcardPolicy: None

- name: Delete original oauth-openshift route
  kubernetes.core.k8s:
    api_version: route.openshift.io/v1
    kind: Route
    name: oauth-openshift
    namespace: openshift-authentication
    state: absent

- name: Get Console URL
  kubernetes.core.k8s_info:
    api_version: route.openshift.io/v1
    kind: Route
    name: console
    namespace: openshift-console
  register: console_route
  retries: 20
  delay: 3
  until: console_route is not failed

- name: Wait for X-Frame-Options header to be removed from Console
  ansible.builtin.uri:
    url: "https://{{ console_route.resources[0].spec.host }}"
    validate_certs: false
    return_content: false
  register: console_response
  failed_when: false
  retries: 15
  delay: 20
  until:
    - console_response.status is defined
    - console_response.status == 200
    - "'x_frame_options' not in console_response"
