= ocp4_workload_showroom_ocp_integration

An Ansible role that prepares an existing OpenShift 4 cluster so the web console can be embedded in a Showroom iframe while keeping OAuth functional.

== Overview

This role runs against an **already provisioned OpenShift 4 cluster** and:

* Removes iframe‑blocking security headers from the default `IngressController`
* Reconfigures the `oauth-openshift` route to use the cluster service CA
* Disables the authentication operator so it cannot revert those changes

It is intended to be called from AgnosticD workloads or standalone playbooks after the cluster is reachable.

== What It Does

[cols="2,3,5",options="header"]
|===
|Area |Object(s) |Change

|Ingress headers
|`IngressController/default` (`openshift-ingress-operator`)
|Deletes response headers `X-Frame-Options`, `Content-Security-Policy`, and `referrer-policy` so the console can render in an iframe.

|OAuth routing
|`Route/oauth-openshift` (`openshift-authentication`)
|Reads the cluster service CA from `ConfigMap/v4-0-config-system-service-ca` and patches the route to use `reencrypt` termination with that CA as `destinationCACertificate`.

|Auth operator
|`Deployment/authentication-operator` and `ResourceQuota/limit-authentication-operator-pods` (`openshift-authentication-operator`)
|Scales the deployment to 0 and enforces a `pods: 0` quota to prevent the operator from reverting the OAuth/ingress changes.

|Lifecycle glue
|`pre_workload.yml`, `post_workload.yml`, `remove_workload.yml`
|Emits lifecycle debug messages around `workload.yml` (controlled by `silent` and `workload_shared_deployment`).
|===

== How It Works

* Logs into the cluster with `oc login` using `openshift_api_url` and `openshift_api_key`, writing a temporary kubeconfig to `/tmp/kubeconfig-demo`.
* Uses `kubernetes.core.k8s` and `kubernetes.core.k8s_info` (with that kubeconfig) to:
** Patch `IngressController/default` to delete iframe‑blocking headers.
** Read `ConfigMap/v4-0-config-system-service-ca` and extract `service-ca.crt`.
** Patch the `oauth-openshift` route to use `reencrypt` TLS with `destinationCACertificate` set to the service CA.
** Scale `Deployment/authentication-operator` to 0 and create a `ResourceQuota` limiting pods to 0 in `openshift-authentication-operator`.
* Waits for the `router-default` deployment in `openshift-ingress` to converge after the ingress changes.
* Fetches the `console` route in `openshift-console` and polls `https://<console-host>` with `ansible.builtin.uri` until the console returns HTTP 200 and the `X-Frame-Options` header is no longer present.

== Configuration

=== Required variables

[cols="1,1,3",options="header"]
|===
|Variable |Type |Description

|`openshift_api_url`
|string
|OpenShift API URL. With or without `https://`. If the protocol is omitted, the role assumes `https://<url>:6443`.

|`openshift_api_key`
|string
|API token for `oc login`. Must have **cluster-admin** privileges.

|`ACTION`
|string
|Workload lifecycle action. Common values: `create`, `provision`, `destroy`, `remove`. See *Behavior by ACTION* below.
|===

=== Role variables

Defaults come from `defaults/main.yml` and task-level `default()` filters.

[cols="1,1,1,3",options="header"]
|===
|Variable |Type |Default |Description

|`become_override`
|boolean
|`false`
|If `true`, forces `become` for all included task files (`pre_workload.yml`, `workload.yml`, `post_workload.yml`, `remove_workload.yml`).

|`silent`
|boolean
|`false`
|If `true`, suppresses informational `debug` output in pre/post/remove tasks.

|`workload_shared_deployment`
|boolean
|`false` (via `| default(false)`)
|Affects only the wording of pre/post debug messages when running on a shared RHPDS cluster.
|===

=== Behavior by ACTION

[cols="1,3",options="header"]
|===
|`ACTION` |Behavior

|`create`, `provision`
|Executes `pre_workload.yml` → `workload.yml` → `post_workload.yml`. Applies all cluster modifications described above.

|`destroy`, `remove`
|Executes `remove_workload.yml` only. Currently this is **informational debug only** and does **not** revert cluster changes.
|===

NOTE: There is no automatic rollback. To revert manually, delete the `ResourceQuota/limit-authentication-operator-pods`, scale `Deployment/authentication-operator` back up, wait for reconciliation, and then remove the ingress header configuration if desired.

== Examples

=== Simple standalone playbook

[source,yaml]
----
- name: Enable OpenShift console iframe embedding
  hosts: localhost
  gather_facts: false
  vars:
    openshift_api_url: "https://api.cluster-abc123.example.com:6443"
    openshift_api_key: "sha256~your-token-here"
    ACTION: provision
  roles:
    - agnosticd.showroom.ocp4_workload_showroom_ocp_integration
----

=== Silent mode on a shared cluster

[source,yaml]
----
- name: Enable OpenShift console iframe embedding (silent, shared cluster)
  hosts: localhost
  gather_facts: false
  vars:
    openshift_api_url: "api.cluster-abc123.example.com"  # protocol optional
    openshift_api_key: "{{ lookup('env', 'OCP_TOKEN') }}"
    ACTION: create
    silent: true
    workload_shared_deployment: true
  roles:
    - agnosticd.showroom.ocp4_workload_showroom_ocp_integration
----

=== Integration from an AgnosticD env_type

[source,yaml]
----
- name: Configure OpenShift for Showroom
  hosts: localhost
  gather_facts: false
  become: false
  tasks:
    - name: Enable console iframe embedding
      include_role:
        name: ocp4_workload_showroom_ocp_integration
      vars:
        ACTION: provision
----

In an AgnosticD environment, `openshift_api_url` and `openshift_api_key` are typically supplied automatically by the cluster provisioning process.
